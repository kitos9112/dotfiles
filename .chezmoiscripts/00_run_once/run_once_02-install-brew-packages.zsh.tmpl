{{- if or (eq .chezmoi.os "linux") (eq .chezmoi.os "darwin") -}}
#! /usr/bin/env bash

set -ev pipefail

# Install Homebrew
which -a brew || /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"

# Ensure brew has been installed in its default place
export PATH=$(brew --prefix)/bin:$(brew --prefix)/sbin:${PATH}


{{- if or (eq .chezmoi.os "linux") }}

# Add 3rd party brew taps
brew tap instrumenta/instrumenta

# Install Homebrew packages
brew update && brew install kubernetes-cli \
                            kops \
                            helm \
                            k9s \
                            borgbackup \
                            sops \
                            hub \
                            git-crypt \
                            yq \
                            fzf \
                            gomplate \
                            kustomize \
                            kubeseal \
                            kubeval \
                            shellcheck \
                            fluxcd/tap/flux \
                            iperf3 \
                            go-task/tap/go-task \
                            figlet \
                            kubetail \
                            lolcat \
                            gh \
                            dty1er/tap/kubecolor \
                            docker-credential-helper-ecr || echo "Catching some errors"
brew upgrade

#  Download fzf binary and update configuration files non interactively
$(brew --prefix)/opt/fzf/install --all
{{- end -}}

{{- if or (eq .chezmoi.os "darwin") }}

# Add brew tap(s)
brew tap fluxcd/tap
brew tap go-task/tap
brew tap dty1er/tap

# Install Homebrew packages
brew bundle --no-lock --file=/dev/stdin <<EOF
    tap "aquasecurity/trivy"
    tap "dty1er/tap"
    tap "fluxcd/tap"
    tap "gabrie30/utils"
    tap "go-task/tap"
    tap "homebrew/bundle"
    tap "homebrew/cask"
    tap "homebrew/core"
    tap "instrumenta/instrumenta"
    brew "readline"
    brew "asdf"
    brew "sqlite"
    brew "xz"
    brew "awscli"
    brew "cargo-instruments"
    brew "chezmoi"
    brew "direnv"
    brew "docker-credential-helper-ecr"
    brew "figlet"
    brew "fzf"
    brew "gh"
    brew "git"
    brew "git-crypt"
    brew "gnupg"
    brew "go"
    brew "gomplate"
    brew "goreleaser"
    brew "grep"
    brew "helm"
    brew "htop"
    brew "hub"
    brew "iperf3"
    brew "jq"
    brew "k9s"
    brew "kubernetes-cli"
    brew "kubectx"
    brew "kubeseal"
    brew "kubeval"
    brew "kustomize"
    brew "lolcat"
    brew "minikube"
    brew "openssl@3"
    brew "qemu"
    brew "podman"
    brew "pyenv"
    brew "saml2aws"
    brew "sevenzip"
    brew "shellcheck"
    brew "sops"
    brew "terraform"
    brew "terragrunt"
    brew "tmux"
    brew "wireshark"
    brew "yq"
    brew "zlib"
    brew "zsh-syntax-highlighting"
    brew "aquasecurity/trivy/trivy"
    brew "fluxcd/tap/flux"
    brew "gabrie30/utils/ghorg"
    brew "go-task/tap/go-task"
    cask "1password"
    cask "authy"
    cask "firefox"
    cask "google-chrome"
    cask "hyper"
    cask "iterm2"
    cask "multipass"
    cask "notion"
    cask "slack"
    cask "spotify"
    cask "unnaturalscrollwheels"
    cask "visual-studio-code"
EOF

{{- end }}

# Upgrade already-installed brew packages
brew update && brew upgrade

#  Download fzf binary and update configuration files non interactively
$(brew --prefix)/opt/fzf/install --all

{{- end -}}
