
{{- if (eq .chezmoi.os "darwin") -}}
#! /usr/bin/env bash
set -ev pipefail

# 1. Install Homebrew
which -a brew || /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
brew="/opt/homebrew/bin/brew"
$brew --version

# 2. Add brew tap(s)
$brew tap fluxcd/tap
$brew tap go-task/tap
$brew tap dty1er/tap

# 3. Install Homebrew packages
## `brew bundle dump` to generate Brewfile
$brew bundle --no-lock --file=/dev/stdin <<EOF
    tap "1password/tap"
    tap "aquasecurity/trivy"
    tap "dty1er/tap"
    tap "fluxcd/tap"
    tap "gabrie30/utils"
    tap "go-task/tap"
    tap "helm/tap"
    tap "homebrew/bundle"
    tap "homebrew/cask"
    tap "homebrew/core"
    tap "homebrew/services"
    tap "instrumenta/instrumenta"
    tap "minamijoyo/hcledit"
    tap "common-fate/granted"
    brew "readline"
    brew "asdf"
    brew "aws-iam-authenticator"
    brew "sqlite"
    brew "xz"
    brew "awscli"
    brew "openssl@3"
    brew "cargo-instruments"
    brew "chezmoi"
    brew "direnv"
    brew "docker-credential-helper-ecr"
    brew "figlet"
    brew "fzf"
    brew "gh"
    brew "git"
    brew "git-crypt"
    brew "pinentry"
    brew "gnupg"
    brew "go"
    brew "gomplate"
    brew "goreleaser"
    brew "grep"
    brew "helm"
    brew "htop"
    brew "hub"
    brew "hyperfine"
    brew "infracost"
    brew "iperf3"
    brew "jq"
    brew "k9s"
    brew "kubernetes-cli"
    brew "kubectx"
    brew "kubeseal"
    brew "kubeval"
    brew "kustomize"
    brew "librsvg"
    brew "lolcat"
    brew "make"
    brew "minikube"
    brew "pinentry-mac"
    brew "qemu"
    brew "podman"
    brew "postgresql@14"
    brew "sevenzip"
    brew "shellcheck"
    brew "smartmontools"
    brew "sops"
    brew "telnet"
    brew "terraform-docs"
    brew "tflint"
    brew "tmux"
    brew "tree"
    brew "velero"
    brew "watch"
    brew "wget"
    brew "wireshark"
    brew "yq"
    brew "zlib"
    brew "zsh-syntax-highlighting"
    brew "aquasecurity/trivy/trivy"
    brew "fluxcd/tap/flux"
    brew "gabrie30/utils/ghorg"
    brew "go-task/tap/go-task"
    brew "helm/tap/chart-releaser"
    brew "minamijoyo/hcledit/hcledit"
    brew "common-fate/granted/granted"
    cask "1password"
    cask "1password-cli"
    cask "authy"
    cask "dbeaver-community"
    cask "firefox"
    cask "google-chrome"
    cask "hyper"
    cask "iterm2"
    cask "multipass"
    cask "notion"
    cask "session-manager-plugin"
    cask "slack"
    cask "spotify"
    cask "unnaturalscrollwheels"
    cask "visual-studio-code"

EOF

# 4. Upgrade already-installed brew packages
$brew update && $brew upgrade

# 5. Download fzf binary and update configuration files non interactively
/opt/homebrew/opt/fzf/install --all
{{- end -}}
