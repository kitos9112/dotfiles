# --- Instant prompt (keep near top) ---
# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# --- Oh My Zsh core ---
# Path to your oh-my-zsh installation.
export ZSH="$HOME/.oh-my-zsh"
ZSH_CUSTOM="$HOME/.oh-my-zsh-custom"

# Set name of the theme to load --- if set to "random", it will
# load a random theme each time oh-my-zsh is loaded, in which case,
# to know which specific one was loaded, run: echo $RANDOM_THEME
# See https://github.com/ohmyzsh/ohmyzsh/wiki/Themes
ZSH_THEME="powerlevel10k/powerlevel10k"

DISABLE_AUTO_UPDATE="true"
DISABLE_UPDATE_PROMPT="true"
ENABLE_CORRECTION="false"
COMPLETION_WAITING_DOTS="true"

# Mute direnv stdout in terminal prompt.
export DIRENV_LOG_FORMAT=""

# --- History settings ---
export HISTFILE="$HOME/.zsh_history"
export HISTSIZE=2000000
export SAVEHIST=2000000

# Shared, near-real-time history across shells
setopt SHARE_HISTORY
unsetopt INC_APPEND_HISTORY
unsetopt INC_APPEND_HISTORY_TIME

# Recommended with SHARE_HISTORY for stability
setopt HIST_FCNTL_LOCK
setopt HIST_SAVE_BY_COPY
setopt EXTENDED_HISTORY        # timestamps (SHARE_HISTORY already uses them; keep consistent)

# Quality / dedupe / hygiene
setopt HIST_IGNORE_ALL_DUPS    # remove older duplicates when a new one arrives
setopt HIST_SAVE_NO_DUPS       # when writing file, omit older duplicates of newer
setopt HIST_REDUCE_BLANKS
setopt HIST_IGNORE_SPACE       # prefix with space to avoid saving sensitive commands
setopt HIST_NO_STORE
setopt HIST_EXPIRE_DUPS_FIRST


# --- Plugins ---
# Which plugins would you like to load?
# Standard plugins can be found in ~/.oh-my-zsh/plugins/*
# Custom plugins may be added to ~/.oh-my-zsh/custom/plugins/
# Example format: plugins=(rails git textmate ruby lighthouse)
# Add wisely, as too many plugins slow down shell startup.
plugins=(
  web-search
  {{- if (lookPath "1password") }}
  1password
  {{- end }}
  {{- if (lookPath "asdf") }}
  asdf
  {{- end }}
  {{- if (lookPath "aws") }}
  aws
  {{- end }}
  {{- if (lookPath "brew") }}
  brew
  {{- end }}
  {{- if (lookPath "chezmoi") }}
  chezmoi
  {{- end }}
  {{- if (lookPath "direnv") }}
  direnv
  {{- end }}
  {{- if (lookPath "docker") }}
  docker
  {{- end }}
  {{- if (lookPath "docker-compose") }}
  docker-compose
  {{- end }}
  {{- if (lookPath "fzf") }}
  fzf
  {{- end }}
  {{- if (lookPath "gh") }}
  gh
  {{- end }}
  {{- if (lookPath "git") }}
  git
  {{- end }}
  {{- if (lookPath "go") }}
  golang
  {{- end }}
  {{- if (lookPath "helm") }}
  helm
  {{- end }}
  {{- if (lookPath "flux") }}
  flux
  {{- end }}
  {{- if (lookPath "kubectl") }}
  kubectl
  {{- end }}
  {{- if (lookPath "kustomize") }}
  kustomize
  {{- end }}
  {{- if (lookPath "pip") }}
  pip
  {{- end }}
  {{ if (eq .osid "linux-ubuntu") }}
  ubuntu
  {{- end }}
  ansible
  aliases
  alias-finder
  history_msr
  zsh-syntax-highlighting
)

# --- Completion paths ---
# https://github.com/zsh-users/zsh-completions/issues/603
fpath+=("${ZSH_CUSTOM:-${ZSH}/custom}/plugins/zsh-completions/src")

source "$ZSH/oh-my-zsh.sh"

autoload -Uz compinit
compinit -u

# --- Prompt + interactive tooling ---
# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ -r "$HOME/.p10k.zsh" ]] && source "$HOME/.p10k.zsh"
# FZF integration (if installed).
[[ -r "$HOME/.fzf.zsh" ]] && source "$HOME/.fzf.zsh"

# --- User environment overrides ---
# Source user-level Zsh environment overrides.
[[ -r "$HOME/.zshenv" ]] && source "$HOME/.zshenv"

# Add extra Zsh env variables or completions available in ~/.env.zsh.
if [ -r "$HOME/.env.zsh" ]; then
  source "$HOME/.env.zsh"
fi

# --- Runtime version managers ---
# >>> Node Version Manager >>>
# NVM - A Node Version Manager
export NVM_DIR="$HOME/.config/nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
# <<< Node Version Manager <<<

# --- OS-specific integrations ---
{{ if (eq .chezmoi.os "darwin") }}
# >>> ITERM2 >>>
test -e "$HOME/.iterm2_shell_integration.zsh" && source "$HOME/.iterm2_shell_integration.zsh"
# <<< ITERM2 <<<

# >>> KRB5 >>>
# export the KRB5 config path if it exists
if [ -f "/opt/homebrew/opt/krb5/bin/kinit" ]; then
  export PATH="/opt/homebrew/opt/krb5/bin:$PATH"
fi
{{ end }}

{{ if (eq .chezmoi.os "linux") }}
# >>> WSL
if uname -a | grep -qPe "(M|m)icrosoft"; then
  if [ -f "$HOME/.op-ssh-agent.sh" ]; then
    source "$HOME/.op-ssh-agent.sh"
  fi
fi
# <<< WSL
{{ end }}
